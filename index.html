<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GembaWalk</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@500&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#f0ede8;--surface:#fff;--surface2:#e8e4de;--border:#d4cfc8;
  --text:#1a1917;--muted:#7a7670;--dim:#a09b95;
  --green:#1a5c3e;--gbg:#e6f2ec;--gbrd:rgba(26,92,62,.25);
  --brown:#7a5230;--bbg:#f2ece4;--bbrd:rgba(122,82,48,.25);
  --red:#c0392b;--rbg:#fbeae8;--gold:#8a6800;--goldbg:#fdf5e0;
  --r:14px;--rs:9px;
}
html,body{height:100%;width:100%;overflow:hidden;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);font-size:15px;}

/* SCREENS */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);transition:transform .3s cubic-bezier(.4,0,.2,1),opacity .3s;overflow:hidden;}
.screen.off{transform:translateX(100%);opacity:0;pointer-events:none;}
.screen.left{transform:translateX(-100%);opacity:0;pointer-events:none;}

/* SCREEN 1 */
#s1{align-items:center;justify-content:center;padding:32px 24px;gap:20px;}
.logo{text-align:center;}
.logo h1{font-size:34px;font-weight:700;letter-spacing:-.02em;color:var(--green);}
.logo h1 span{color:var(--text);font-weight:300;}
.logo p{font-size:13px;color:var(--muted);margin-top:3px;}
.flabel{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:5px;}
input[type=text]{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:15px;padding:11px 13px;outline:none;transition:border-color .15s;}
input[type=text]:focus{border-color:var(--green);}
.tcards{width:100%;display:flex;flex-direction:column;gap:10px;}
.tcard{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s;}
.tcard:active{transform:scale(.98);}
.tcard.sa{border-color:var(--green);background:var(--gbg);}
.tcard.sb{border-color:var(--brown);background:var(--bbg);}
.tcard .em{font-size:30px;flex-shrink:0;}
.tcard .tt h3{font-size:16px;font-weight:600;}
.tcard .tt p{font-size:12px;color:var(--muted);margin-top:2px;}
.tcard.sa .tt h3{color:var(--green);}
.tcard.sb .tt h3{color:var(--brown);}
.sbtn{width:100%;padding:14px;background:var(--green);color:#fff;border:none;border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:all .15s;opacity:.4;pointer-events:none;}
.sbtn.on{opacity:1;pointer-events:all;}
.sbtn:active{transform:scale(.98);}

/* SCREEN 2 */
#s2{display:flex;flex-direction:column;}
.abar{background:var(--surface);border-bottom:1.5px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.abar-l h2{font-size:13px;font-weight:700;letter-spacing:.06em;color:var(--green);}
.abar-l .meta{font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.abar-r{display:flex;gap:7px;align-items:center;}
.pill{font-size:9px;font-weight:700;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.06em;}
.pa{background:var(--gbg);color:var(--green);border:1px solid var(--gbrd);}
.pb{background:var(--bbg);color:var(--brown);border:1px solid var(--bbrd);}
.endbtn{font-size:11px;font-weight:500;padding:5px 10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:6px;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;color:var(--text);}

.tcontent{flex:1;overflow:hidden;position:relative;}
.tpane{position:absolute;inset:0;overflow-y:auto;visibility:hidden;opacity:0;pointer-events:none;-webkit-overflow-scrolling:touch;background:var(--bg);}
.tpane.on{visibility:visible;opacity:1;pointer-events:all;}

.bnav{background:var(--surface);border-top:1.5px solid var(--border);display:flex;flex-shrink:0;}
.nbtn{flex:1;padding:8px 0 10px;display:flex;flex-direction:column;align-items:center;gap:2px;border:none;background:none;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);transition:color .15s;}
.nbtn .ni{font-size:20px;}
.nbtn.on{color:var(--green);}

/* ERFASSUNG */
#pe{padding:10px 12px;display:flex;flex-direction:column;gap:8px;}
select{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:14px;padding:9px 32px 9px 11px;outline:none;appearance:none;cursor:pointer;transition:border-color .15s;}
select:focus{border-color:var(--green);}
.sw{position:relative;}
.sa2{position:absolute;right:11px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--muted);font-size:11px;}
textarea{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:13px;padding:8px 11px;outline:none;resize:none;transition:border-color .15s;line-height:1.4;}
textarea:focus{border-color:var(--green);}
.trow{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);padding:8px 12px;display:flex;align-items:center;justify-content:space-between;}
.tval{font-family:'IBM Plex Mono',monospace;font-size:30px;font-weight:500;color:var(--text);transition:color .2s;}
.tval.run{color:var(--green);}
.tstat{font-size:10px;color:var(--muted);margin-top:1px;display:flex;align-items:center;gap:5px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--red);display:none;animation:blink 1.2s infinite;}
.dot.on{display:inline-block;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.tbtn{padding:9px 20px;border:none;border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;flex-shrink:0;}
.tbtn:active{transform:scale(.96);}
.bstart{background:var(--green);color:#fff;}
.bstop{background:var(--red);color:#fff;}
.tgs{display:flex;flex-wrap:wrap;gap:6px;}
.tag{padding:5px 11px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:var(--surface);color:var(--muted);transition:all .12s;white-space:nowrap;}
.tag:active{transform:scale(.95);}
.ws{background:var(--gbg);border-color:var(--green);color:var(--green);font-weight:600;}
.nws{background:var(--rbg);border-color:var(--red);color:var(--red);font-weight:600;}
.nn{background:var(--goldbg);border-color:var(--gold);color:var(--gold);font-weight:600;}
.vj{background:var(--gbg);border-color:var(--green);color:var(--green);font-weight:600;}
.vn{background:var(--surface2);border-color:var(--muted);color:var(--text);font-weight:600;}
.bet{background:var(--surface2);border-color:var(--text);color:var(--text);font-weight:600;}
.chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:3px 9px;font-size:11px;color:var(--muted);cursor:pointer;}
.chip:active{background:var(--gbg);color:var(--green);}
.div{border:none;border-top:1.5px solid var(--border);}

/* EINTRAEGE */
#pin{padding:10px 12px;}
.lhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.lcnt{font-size:12px;color:var(--muted);}
.bsm{font-size:11px;padding:5px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:6px;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;color:var(--text);}
.elist{display:flex;flex-direction:column;gap:7px;}
.ecard{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);padding:10px 12px;display:flex;align-items:flex-start;gap:8px;}
.ebar{width:3px;border-radius:3px;align-self:stretch;min-height:32px;flex-shrink:0;}
.bws{background:var(--green);}.bnws{background:var(--red);}.bnn{background:var(--gold);}.bx{background:var(--border);}
.ebody{flex:1;min-width:0;}
.etask{font-weight:600;font-size:13px;}
.epat{font-size:11px;color:var(--muted);margin-top:1px;}
.etags{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;}
.mt{font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;text-transform:uppercase;letter-spacing:.03em;}
.mws{background:var(--gbg);color:var(--green);}
.mnws{background:var(--rbg);color:var(--red);}
.mnn{background:var(--goldbg);color:var(--gold);}
.mv{background:var(--gbg);color:var(--green);}
.mnv{background:var(--surface2);color:var(--muted);}
.enote{font-size:11px;color:var(--dim);margin-top:3px;font-style:italic;}
.er{text-align:right;flex-shrink:0;}
.edur{font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:600;color:var(--green);}
.etime{font-size:9px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
.edel{background:none;border:none;color:var(--dim);font-size:14px;cursor:pointer;display:block;margin-top:4px;}
.edel:active{color:var(--red);}
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.eico{font-size:36px;margin-bottom:8px;}

/* MONITORING */
#pm{padding:10px 12px;}
.kgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.kbox{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);padding:10px;text-align:center;}
.kval{font-family:'IBM Plex Mono',monospace;font-size:20px;font-weight:500;color:var(--green);}
.klbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-top:2px;}
.stitle{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:12px 0 7px;padding-bottom:5px;border-bottom:1.5px solid var(--border);}
.togrow{display:flex;background:var(--surface2);border-radius:8px;padding:3px;margin-bottom:10px;}
.tog{flex:1;padding:6px 4px;text-align:center;font-size:12px;font-weight:500;cursor:pointer;border-radius:6px;color:var(--muted);border:none;background:none;font-family:'IBM Plex Sans',sans-serif;transition:all .15s;}
.tog.on{background:var(--surface);color:var(--text);font-weight:600;}
.bitem{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.bname{font-size:12px;width:120px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btrack{flex:1;background:var(--surface2);border-radius:3px;height:7px;overflow:hidden;}
.bfill{height:100%;border-radius:3px;transition:width .4s;}
.fg{background:var(--green);}.fr{background:var(--red);}.fgo{background:var(--gold);}
.bval{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);width:38px;text-align:right;}
.ebox{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rs);padding:12px;margin-top:4px;}
.einfo{font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.5;}
.bexp{width:100%;padding:10px;background:var(--green);color:#fff;border:none;border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:8px;}
.bemail{width:100%;padding:10px;background:var(--surface2);border:1.5px solid var(--border);color:var(--text);border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;}
.hint{background:var(--gbg);border:1px solid var(--gbrd);border-radius:var(--rs);padding:10px;font-size:11px;color:var(--green);line-height:1.5;margin-top:8px;}
.hint strong{display:block;margin-bottom:2px;font-size:12px;}

.toast{position:fixed;bottom:72px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--text);color:#fff;padding:8px 18px;border-radius:20px;font-size:12px;font-weight:500;opacity:0;transition:all .25s;z-index:999;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- SCREEN 1 -->
<div class="screen" id="s1">
  <div class="logo">
    <h1>Gemba<span>Walk</span></h1>
    <p>Zeiterfassung &amp; Prozessbeobachtung</p>
  </div>
  <div style="width:100%;">
    <div class="flabel">Beobachter/in</div>
    <input type="text" id="obsInput" placeholder="Name eingeben‚Ä¶" autocomplete="off" oninput="chkReady()">
  </div>
  <div class="tcards">
    <div class="tcard" id="cA" onclick="pickGType('arzt')">
      <div class="em">üë®‚Äç‚öïÔ∏è</div>
      <div class="tt"><h3>Arzt / Pflege</h3><p>Patientenkontakt, KISIM, Dokumentation</p></div>
    </div>
    <div class="tcard" id="cB" onclick="pickGType('admin')">
      <div class="em">üóÇÔ∏è</div>
      <div class="tt"><h3>Administration</h3><p>Koordination, Berichtswesen, Verwaltung</p></div>
    </div>
  </div>
  <button class="sbtn" id="sBtn" onclick="launch()">Gemba starten ‚Üí</button>
</div>

<!-- SCREEN 2 -->
<div class="screen off" id="s2">
  <div class="abar">
    <div class="abar-l">
      <h2>GEMBA WALK</h2>
      <div class="meta" id="aMeta"></div>
    </div>
    <div class="abar-r">
      <span class="pill" id="aPill"></span>
      <button class="endbtn" onclick="endSess()">‚Ü© Ende</button>
    </div>
  </div>

  <div class="tcontent">
    <div class="tpane on" id="pe">
      <div>
        <div class="flabel">Aktivit√§t</div>
        <div class="sw"><select id="tSel"><option value="">‚Äì Task w√§hlen ‚Äì</option></select><div class="sa2">‚ñº</div></div>
        <div class="chips" id="rTasks"></div>
      </div>
      <div>
        <div class="flabel">Patient / Fall</div>
        <input type="text" id="pInput" placeholder="Name oder K√ºrzel‚Ä¶" autocomplete="off">
        <div class="chips" id="rPats"></div>
      </div>
      <div class="trow">
        <div>
          <div class="tval" id="tDisp">00:00:00</div>
          <div class="tstat"><span class="dot" id="dot"></span><span id="tLbl">Bereit</span></div>
        </div>
        <button class="tbtn bstart" id="tBtn" onclick="togTimer()">‚ñ∂ Start</button>
      </div>
      <hr class="div">
      <div>
        <div class="flabel">T√§tigkeitstyp</div>
        <div class="tgs" id="gTyp">
          <div class="tag" data-v="wertsch√∂pfend" onclick="pTyp(this)">‚úÖ Wertsch√∂pfend</div>
          <div class="tag" data-v="nicht wertsch√∂pfend" onclick="pTyp(this)">‚ùå Nicht wertsch√∂pfend</div>
          <div class="tag" data-v="notwendig nicht wertsch√∂pfend" onclick="pTyp(this)">‚ö†Ô∏è Notwendig</div>
        </div>
      </div>
      <div>
        <div class="flabel">Verrechnung</div>
        <div class="tgs" id="gVerr">
          <div class="tag" data-v="ja" onclick="pVerr(this)">üí∞ Verrechenbar</div>
          <div class="tag" data-v="nein" onclick="pVerr(this)">‚Äî Nicht verrechenbar</div>
        </div>
      </div>
      <div id="gBetWrap" style="display:none;">
        <div class="flabel">Beteiligt</div>
        <div class="tgs" id="gBet">
          <div class="tag" data-v="Oberarzt" onclick="pBet(this)">Oberarzt</div>
          <div class="tag" data-v="Assistenzarzt" onclick="pBet(this)">Assistenzarzt</div>
          <div class="tag" data-v="Chirurg" onclick="pBet(this)">Chirurg</div>
          <div class="tag" data-v="An√§sthesie" onclick="pBet(this)">An√§sthesie</div>
          <div class="tag" data-v="Pflege" onclick="pBet(this)">Pflege</div>
          <div class="tag" data-v="Patient" onclick="pBet(this)">Patient</div>
          <div class="tag" data-v="Therapie" onclick="pBet(this)">Therapie</div>
          <div class="tag" data-v="Supervision" onclick="pBet(this)">Supervision</div>
        </div>
      </div>
      <div>
        <div class="flabel">Kommentar (optional)</div>
        <textarea id="kom" rows="2" placeholder="Beobachtung, Idee, Potenzial‚Ä¶"></textarea>
      </div>
    </div>

    <div class="tpane" id="pin">
      <div class="lhdr">
        <div class="lcnt"><span id="eCnt">0</span> Eintr√§ge</div>
        <button class="bsm" onclick="clearAll()">üóë Alle l√∂schen</button>
      </div>
      <div class="elist" id="eList"><div class="empty"><div class="eico">‚è±Ô∏è</div><p>Noch keine Eintr√§ge.</p></div></div>
    </div>

    <div class="tpane" id="pm">
      <div class="kgrid">
        <div class="kbox"><div class="kval" id="kT">‚Äì</div><div class="klbl">Gesamtzeit</div></div>
        <div class="kbox"><div class="kval" id="kC">‚Äì</div><div class="klbl">Eintr√§ge</div></div>
        <div class="kbox"><div class="kval" id="kW">‚Äì</div><div class="klbl">Wertsch√∂pfend</div></div>
        <div class="kbox"><div class="kval" id="kV">‚Äì</div><div class="klbl">Verrechenbar</div></div>
      </div>
      <div class="togrow" id="mTog">
        <button class="tog on" onclick="setMon('task',this)">Nach Task</button>
        <button class="tog" onclick="setMon('patient',this)">Nach Patient</button>
        <button class="tog" onclick="setMon('type',this)">T√§tigkeitstyp</button>
      </div>
      <div id="mBars"></div>
      <div class="stitle">Export</div>
      <div class="ebox">
        <div class="einfo">CSV im Screening-Format f√ºr Excel &amp; SharePoint.</div>
        <button class="bexp" onclick="doExport()">üì• CSV + Monitoring herunterladen</button>
        <button class="bemail" onclick="doEmail()">üìß Bericht an carmen.huber@kispisg.ch</button>
        <div class="hint"><strong>üí° SharePoint-Tipp</strong>CSV hochladen ‚Üí Excel √∂ffnen ‚Üí Pivot-Auswertung.</div>
      </div>
    </div>
  </div>

  <div class="bnav">
    <button class="nbtn on" id="n0" onclick="swTab(0)"><span class="ni">‚è±Ô∏è</span>Erfassung</button>
    <button class="nbtn" id="n1" onclick="swTab(1)"><span class="ni">üìã</span>Eintr√§ge</button>
    <button class="nbtn" id="n2" onclick="swTab(2)"><span class="ni">üìä</span>Monitoring</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var TASKS={
  arzt:['Patientenanmeldung','Arztrapport / √úbergabe','KISIM lesen','Fallvorbereitung / Informationssuche','Besprechung Patient','Patientenbesuch / Untersuchung','Teaching / Supervision','Labor / Bildgebung','Interprofessionelle Abstimmung','Telefonat intern','Telefonat extern','KISIM Dokumentation','Medi-Erfassung','Rezept schreiben','Leistungserfassung','Bericht schreiben','Warten auf Arzt / Pflege','Warten auf Patient','Administrative T√§tigkeit','Sonstiges'],
  admin:['Terminkoordination mit Arzt','Terminkoordination mit Patient','Terminkoordination externe Partner','Terminkoordination interne Partner','Berichtswesen','E-Mail Bearbeitung','Telefon intern','Telefon extern','Dokumentenablage / Archivierung','Rechnungsstellung / Codierung','Informationssuche','Meeting / Besprechung','Datenpflege / Systemerfassung','Warten / Leerlauf','Sonstiges']
};

var G={type:'',obs:'',entries:[],timer:{run:false,start:null,ms:0,iv:null},styp:'',sverr:'',sbet:[],rp:[],rt:[],date:'',mon:'task'};

function pickGType(t){
  G.type=t;
  document.getElementById('cA').className='tcard'+(t==='arzt'?' sa':'');
  document.getElementById('cB').className='tcard'+(t==='admin'?' sb':'');
  chkReady();
}
function chkReady(){
  var ok=document.getElementById('obsInput').value.trim()&&G.type;
  document.getElementById('sBtn').className='sbtn'+(ok?' on':'');
}
function launch(){
  G.obs=document.getElementById('obsInput').value.trim()||'Anonym';
  G.date=new Date().toLocaleDateString('de-CH');
  G.entries=lsLoad();
  document.getElementById('aMeta').textContent=G.obs+' ¬∑ '+G.date;
  var pill=document.getElementById('aPill');
  if(G.type==='arzt'){pill.textContent='üë®‚Äç‚öïÔ∏è Arzt/Pflege';pill.className='pill pa';document.getElementById('gBetWrap').style.display='';}
  else{pill.textContent='üóÇÔ∏è Admin';pill.className='pill pb';document.getElementById('gBetWrap').style.display='none';}
  buildSel();renderChips();renderEntries();renderMon();
  document.getElementById('s1').classList.add('left');
  document.getElementById('s2').classList.remove('off');
}
function endSess(){
  if(G.entries.length&&!confirm('Session beenden?'))return;
  stopClean();G.entries=[];G.styp='';G.sverr='';G.sbet=[];G.rp=[];G.rt=[];G.type='';
  document.getElementById('obsInput').value='';
  document.getElementById('cA').className='tcard';document.getElementById('cB').className='tcard';
  document.getElementById('sBtn').className='sbtn';
  document.getElementById('s2').classList.add('off');document.getElementById('s1').classList.remove('left');
  swTab(0);
}
function lsLoad(){try{return JSON.parse(localStorage.getItem('gw_'+G.type)||'[]');}catch(e){return[];}}
function lsSave(){try{localStorage.setItem('gw_'+G.type,JSON.stringify(G.entries));}catch(e){}}

function buildSel(){
  var sel=document.getElementById('tSel'),tasks=TASKS[G.type],rec=G.rt.slice(0,5),oth=tasks.filter(function(t){return rec.indexOf(t)<0;});
  sel.innerHTML='<option value="">‚Äì Task w√§hlen ‚Äì</option>';
  if(rec.length){var g1=document.createElement('optgroup');g1.label='üïê Zuletzt verwendet';rec.forEach(function(t){g1.appendChild(new Option(t,t));});sel.appendChild(g1);var g2=document.createElement('optgroup');g2.label='Alle Tasks';oth.forEach(function(t){g2.appendChild(new Option(t,t));});sel.appendChild(g2);}
  else{tasks.forEach(function(t){sel.appendChild(new Option(t,t));});}
}
function renderChips(){
  var pc=document.getElementById('rPats');pc.innerHTML='';
  G.rp.slice(0,6).forEach(function(p){var c=document.createElement('div');c.className='chip';c.textContent=p;c.onclick=function(){document.getElementById('pInput').value=p;};pc.appendChild(c);});
  var tc=document.getElementById('rTasks');tc.innerHTML='';
  G.rt.slice(0,4).forEach(function(t){var c=document.createElement('div');c.className='chip';c.textContent=t;c.onclick=function(){document.getElementById('tSel').value=t;};tc.appendChild(c);});
}

function togTimer(){
  if(G.timer.run){stopClean();saveEntry();}
  else{G.timer.run=true;G.timer.start=Date.now();G.timer.iv=setInterval(tick,500);tick();document.getElementById('tBtn').textContent='‚èπ Stop';document.getElementById('tBtn').className='tbtn bstop';document.getElementById('dot').classList.add('on');}
}
function tick(){
  var tot=G.timer.ms+(G.timer.run?Date.now()-G.timer.start:0);
  var h=Math.floor(tot/3600000),m=Math.floor((tot%3600000)/60000),s=Math.floor((tot%60000)/1000);
  var p=function(n){return String(n).padStart(2,'0');};
  document.getElementById('tDisp').textContent=p(h)+':'+p(m)+':'+p(s);
  document.getElementById('tDisp').className='tval'+(G.timer.run?' run':'');
  document.getElementById('tLbl').textContent=G.timer.run?(document.getElementById('tSel').value||'L√§uft‚Ä¶'):'Gestoppt';
}
function stopClean(){
  if(G.timer.run){G.timer.ms+=Date.now()-G.timer.start;G.timer.run=false;}
  clearInterval(G.timer.iv);
  document.getElementById('tBtn').textContent='‚ñ∂ Start';document.getElementById('tBtn').className='tbtn bstart';document.getElementById('dot').classList.remove('on');tick();
}
function resetTimer(){G.timer={run:false,start:null,ms:0,iv:null};document.getElementById('tDisp').textContent='00:00:00';document.getElementById('tDisp').className='tval';document.getElementById('tLbl').textContent='Bereit';}

function pTyp(el){document.querySelectorAll('#gTyp .tag').forEach(function(t){t.className='tag';});G.styp=el.dataset.v;el.classList.add(G.styp==='wertsch√∂pfend'?'ws':G.styp==='nicht wertsch√∂pfend'?'nws':'nn');}
function pVerr(el){document.querySelectorAll('#gVerr .tag').forEach(function(t){t.className='tag';});G.sverr=el.dataset.v;el.classList.add(el.dataset.v==='ja'?'vj':'vn');}
function pBet(el){var v=el.dataset.v;if(G.sbet.indexOf(v)>=0){G.sbet=G.sbet.filter(function(x){return x!==v;});el.className='tag';}else{G.sbet.push(v);el.classList.add('bet');}}

function saveEntry(){
  var task=document.getElementById('tSel').value;
  if(!task||G.timer.ms===0)return;
  var now=new Date();
  G.entries.unshift({id:Date.now(),time:now.toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'}),ts:now.toISOString(),task:task,pat:document.getElementById('pInput').value.trim(),typ:G.styp,verr:G.sverr,bet:G.sbet.slice(),note:document.getElementById('kom').value.trim(),ms:G.timer.ms,min:Math.round(G.timer.ms/60000*10)/10,obs:G.obs,gtype:G.type});
  lsSave();
  var p=document.getElementById('pInput').value.trim();
  if(p)G.rp=[p].concat(G.rp.filter(function(x){return x!==p;})).slice(0,8);
  G.rt=[task].concat(G.rt.filter(function(x){return x!==task;})).slice(0,6);
  buildSel();renderChips();
  resetTimer();
  document.getElementById('tSel').value='';document.getElementById('pInput').value='';document.getElementById('kom').value='';
  document.querySelectorAll('#gTyp .tag,#gVerr .tag,#gBet .tag').forEach(function(t){t.className='tag';});
  G.styp='';G.sverr='';G.sbet=[];
  renderEntries();renderMon();
  toast('‚úÖ Gespeichert');
}

function renderEntries(){
  document.getElementById('eCnt').textContent=G.entries.length;
  var c=document.getElementById('eList');
  if(!G.entries.length){c.innerHTML='<div class="empty"><div class="eico">‚è±Ô∏è</div><p>Noch keine Eintr√§ge.</p></div>';return;}
  c.innerHTML=G.entries.map(function(e){
    var bar=e.typ==='wertsch√∂pfend'?'bws':e.typ==='nicht wertsch√∂pfend'?'bnws':e.typ==='notwendig nicht wertsch√∂pfend'?'bnn':'bx';
    var tags='';
    if(e.typ==='wertsch√∂pfend')tags+='<span class="mt mws">Wertsch.</span>';
    else if(e.typ==='nicht wertsch√∂pfend')tags+='<span class="mt mnws">Nicht w.</span>';
    else if(e.typ)tags+='<span class="mt mnn">Notwendig</span>';
    if(e.verr==='ja')tags+='<span class="mt mv">Verr.</span>';
    else if(e.verr==='nein')tags+='<span class="mt mnv">Nicht verr.</span>';
    if(e.bet&&e.bet.length)tags+='<span class="mt" style="background:var(--surface2);color:var(--muted);">'+e.bet.join(', ')+'</span>';
    return '<div class="ecard"><div class="ebar '+bar+'"></div><div class="ebody"><div class="etask">'+e.task+'</div>'+(e.pat?'<div class="epat">üë§ '+e.pat+'</div>':'')+(tags?'<div class="etags">'+tags+'</div>':'')+(e.note?'<div class="enote">üí¨ '+e.note+'</div>':'')+'</div><div class="er"><div class="edur">'+fmtMin(e.min)+'</div><div class="etime">'+e.time+'</div><button class="edel" onclick="delE('+e.id+')">‚úï</button></div></div>';
  }).join('');
}
function delE(id){G.entries=G.entries.filter(function(e){return e.id!==id;});lsSave();renderEntries();renderMon();}
function clearAll(){if(!G.entries.length)return;if(!confirm('Alle l√∂schen?'))return;G.entries=[];lsSave();renderEntries();renderMon();}

function setMon(v,btn){G.mon=v;document.querySelectorAll('#mTog .tog').forEach(function(b){b.classList.remove('on');});btn.classList.add('on');renderMon();}
function renderMon(){
  var e=G.entries,tot=e.reduce(function(s,x){return s+x.ms;},0);
  var ws=e.filter(function(x){return x.typ==='wertsch√∂pfend';}).reduce(function(s,x){return s+x.ms;},0);
  var vr=e.filter(function(x){return x.verr==='ja';}).reduce(function(s,x){return s+x.ms;},0);
  document.getElementById('kT').textContent=fmtMs(tot);document.getElementById('kC').textContent=e.length;
  document.getElementById('kW').textContent=tot>0?Math.round(ws/tot*100)+'%':'‚Äì';document.getElementById('kV').textContent=tot>0?Math.round(vr/tot*100)+'%':'‚Äì';
  var bars=document.getElementById('mBars');
  if(!e.length){bars.innerHTML='<div class="empty" style="padding:20px 0;"><p>Keine Daten</p></div>';return;}
  if(G.mon==='type'){
    var types=[{k:'wertsch√∂pfend',l:'Wertsch√∂pfend',c:'fg'},{k:'nicht wertsch√∂pfend',l:'Nicht wertsch√∂pfend',c:'fr'},{k:'notwendig nicht wertsch√∂pfend',l:'Notwendig, n.w.',c:'fgo'},{k:'',l:'Nicht klassifiziert',c:'fg'}];
    var mx=0;types.forEach(function(t){t.ms=e.filter(function(x){return x.typ===t.k;}).reduce(function(s,x){return s+x.ms;},0);if(t.ms>mx)mx=t.ms;});
    bars.innerHTML=types.filter(function(t){return t.ms>0;}).map(function(t){return brow(t.l,t.ms,mx,t.c,tot>0?Math.round(t.ms/tot*100)+'%':'-');}).join('');
  }else{
    var key=G.mon==='task'?'task':'pat',map={};
    e.forEach(function(x){var k=x[key]||(key==='pat'?'(kein Patient)':'‚Äì');map[k]=(map[k]||0)+x.ms;});
    var sorted=Object.entries(map).sort(function(a,b){return b[1]-a[1];});
    var mx2=sorted.length?sorted[0][1]:1;
    bars.innerHTML=sorted.map(function(item){return brow(item[0],item[1],mx2,'fg',fmtMin(item[1]/60000));}).join('');
  }
}
function brow(name,ms,max,cls,lbl){return '<div class="bitem"><div class="bname" title="'+name+'">'+name+'</div><div class="btrack"><div class="bfill '+cls+'" style="width:'+Math.round(ms/max*100)+'%"></div></div><div class="bval">'+lbl+'</div></div>';}

function buildMonSummary(){
  var e=G.entries,tot=e.reduce(function(s,x){return s+x.ms;},0);
  var pct=function(ms){return tot>0?Math.round(ms/tot*100)+'%':'-';};
  var ws=e.filter(function(x){return x.typ==='wertsch√∂pfend';}).reduce(function(s,x){return s+x.ms;},0);
  var nws=e.filter(function(x){return x.typ==='nicht wertsch√∂pfend';}).reduce(function(s,x){return s+x.ms;},0);
  var nn=e.filter(function(x){return x.typ==='notwendig nicht wertsch√∂pfend';}).reduce(function(s,x){return s+x.ms;},0);
  var vr=e.filter(function(x){return x.verr==='ja';}).reduce(function(s,x){return s+x.ms;},0);
  var tm={};e.forEach(function(x){tm[x.task]=(tm[x.task]||0)+x.ms;});
  var pm={};e.forEach(function(x){if(x.pat)pm[x.pat]=(pm[x.pat]||0)+x.ms;});
  var lines=[
    ['GEMBA WALK MONITORING-BERICHT','','',''],
    ['Datum',G.date,'',''],
    ['Beobachter/in',G.obs,'',''],
    ['Typ',G.type==='arzt'?'Arzt/Pflege':'Administration','',''],
    ['Eintr√§ge',e.length,'',''],
    ['Gesamtzeit',fmtMs(tot),'',''],
    ['','','',''],
    ['T√ÑTIGKEITSTYPEN','Dauer','Anteil',''],
    ['Wertsch√∂pfend',fmtMs(ws),pct(ws),''],
    ['Nicht wertsch√∂pfend',fmtMs(nws),pct(nws),''],
    ['Notwendig, nicht wertsch√∂pfend',fmtMs(nn),pct(nn),''],
    ['','','',''],
    ['VERRECHNUNG','Dauer','Anteil',''],
    ['Verrechenbar',fmtMs(vr),pct(vr),''],
    ['Nicht verrechenbar',fmtMs(tot-vr),pct(tot-vr),''],
    ['','','',''],
    ['TASKS NACH ZEITAUFWAND','Dauer','Anteil','']
  ];
  Object.entries(tm).sort(function(a,b){return b[1]-a[1];}).forEach(function(x){lines.push([x[0],fmtMs(x[1]),pct(x[1]),'']);});
  lines.push(['','','','']);
  lines.push(['PATIENTEN NACH ZEITAUFWAND','Dauer','','']);
  Object.entries(pm).sort(function(a,b){return b[1]-a[1];}).forEach(function(x){lines.push([x[0],fmtMs(x[1]),'','']);});
  return lines;
}

function doExport(){
  if(!G.entries.length){toast('Keine Eintr√§ge');return;}
  // Sheet 1: Eintr√§ge
  var hdr=['Zeit','Datum','Aktivit√§t','Patient','Gemba-Typ','Beobachter','T√§tigkeitstyp','Verrechnung','Beteiligt','Dauer (min)','Kommentar'];
  var rows=G.entries.slice().reverse().map(function(e){return[e.time,new Date(e.ts).toLocaleDateString('de-CH'),e.task,e.pat||'',e.gtype==='arzt'?'Arzt/Pflege':'Admin',e.obs,e.typ||'',e.verr||'',(e.bet||[]).join('; '),e.min,e.note||''];});
  var csv1=[hdr].concat(rows).map(function(r){return r.map(function(v){return'"'+String(v).replace(/"/g,'""')+'"';}).join(';');}).join('\n');
  // Sheet 2: Monitoring (appended after separator)
  var mon=buildMonSummary();
  var csv2=mon.map(function(r){return r.map(function(v){return'"'+String(v).replace(/"/g,'""')+'"';}).join(';');}).join('\n');
  var full=csv1+'\n\n;;MONITORING-AUSWERTUNG;;;;;;;\n'+csv2;
  var blob=new Blob(['\uFEFF'+full],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url;a.download='GembaWalk_'+G.date.replace(/\./g,'-')+'.csv';a.click();URL.revokeObjectURL(url);
  toast('‚úÖ CSV mit Monitoring exportiert');
}
function doEmail(){
  if(!G.entries.length){toast('Keine Eintr√§ge');return;}
  var tot=G.entries.reduce(function(s,e){return s+e.ms;},0);
  var ws=G.entries.filter(function(e){return e.typ==='wertsch√∂pfend';}).reduce(function(s,e){return s+e.ms;},0);
  var nws=G.entries.filter(function(e){return e.typ==='nicht wertsch√∂pfend';}).reduce(function(s,e){return s+e.ms;},0);
  var nn=G.entries.filter(function(e){return e.typ==='notwendig nicht wertsch√∂pfend';}).reduce(function(s,e){return s+e.ms;},0);
  var vr=G.entries.filter(function(e){return e.verr==='ja';}).reduce(function(s,e){return s+e.ms;},0);
  var pct=function(ms){return tot>0?Math.round(ms/tot*100)+'%':'-';};
  var tm={};G.entries.forEach(function(e){tm[e.task]=(tm[e.task]||0)+e.ms;});
  var pm={};G.entries.forEach(function(e){if(e.pat)pm[e.pat]=(pm[e.pat]||0)+e.ms;});
  var lines=['Gemba Walk Bericht','==================','Datum: '+G.date,'Beobachter/in: '+G.obs,'Typ: '+(G.type==='arzt'?'Arzt/Pflege':'Administration'),'Eintraege: '+G.entries.length,'Gesamtzeit: '+fmtMs(tot),'','TAETIGKEITSTYPEN','----------------','Wertschoepfend: '+fmtMs(ws)+' ('+pct(ws)+')','Nicht wertschoepfend: '+fmtMs(nws)+' ('+pct(nws)+')','Notwendig: '+fmtMs(nn)+' ('+pct(nn)+')','','VERRECHNUNG','-----------','Verrechenbar: '+fmtMs(vr)+' ('+pct(vr)+')','','TASKS (nach Zeit)','------------------'];
  Object.entries(tm).sort(function(a,b){return b[1]-a[1];}).forEach(function(x){lines.push('  '+x[0]+': '+fmtMs(x[1])+' ('+pct(x[1])+')');});
  lines.push('','PATIENTEN','---------');
  Object.entries(pm).sort(function(a,b){return b[1]-a[1];}).forEach(function(x){lines.push('  '+x[0]+': '+fmtMs(x[1]));});
  lines.push('','(CSV-Export mit vollstaendiger Auswertung separat herunterladen)');
  var subj=encodeURIComponent('Gemba Walk Bericht - '+G.date+' - '+G.obs);
  var body=encodeURIComponent(lines.join('\n'));
  window.location.href='mailto:carmen.huber@kispisg.ch?subject='+subj+'&body='+body;
}

function swTab(i){
  ['pe','pin','pm'].forEach(function(id,j){document.getElementById(id).className='tpane'+(i===j?' on':'');});
  for(var j=0;j<3;j++)document.getElementById('n'+j).className='nbtn'+(i===j?' on':'');
  if(i===1)renderEntries();if(i===2)renderMon();
}
function fmtMs(ms){if(!ms)return'0m';var h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000);return h>0?h+'h '+m+'m':m+'m';}
function fmtMin(min){if(!min||min<0.05)return'0m';var h=Math.floor(min/60),m=Math.round(min%60);return h>0?h+'h '+m+'m':m+'m';}
function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
</script>
</body>
</html>
